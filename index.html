<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>Database of federal crowdsourcing and citizen science projects, by Commons Lab - Wilson Center</title>
    <link rel="stylesheet" href="css/cartodb.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body class="container-fluid">

    <header>
      <nav class="row">
        <div class="col-md-6">
          <image xlink:href="img/commons_logo.svg" src="img/commons_logo.png"
                 width="260" height="40" />
          <!-- <image xlink:href="img/wilson_logo.svg" src="img/wilson_logo.png" -->
          <!--        width="260" height="40" /> -->
        </div>
        <div class="col-md-6">
          <span><a href="about.html">About</a></span>
          <span><a class="lead-btn" href="add.html">Add project</a></span>
          <span><a class="current" href="index.html">Home</a></span>
        </div>
      </nav>
      <section id="hero-intro" class="row">
        <h2>Database of federal crowdsourcing and citizen science projects</h2>
      </section>
    </header>

    <main class="main-content row">

      <section id="project_panel" class="hidden">
          <div id="project_data" class="row"></div>
        </section>

      <section id="filters" class="col-md-2">

        <p><small>
          FIND PROJECTS: <a href="#" data-toggle="tooltip" data-placement="right" title=""
              data-original-title="Search by project name, description and keywords. Leave blank to show all">
            <span class="glyphicon glyphicon-info-sign"></span></a>

        </small></p>

          <div class="input-group">
            <input id="searchinput" class="form-control" placeholder="Search for..." value="" type="search"> <span id="searchclear" class="glyphicon glyphicon-remove-circle" style="display: none;"></span>
            <span class="input-group-btn">
              <button id="filter-btn" class="btn btn-default" type="button"><i class="glyphicon glyphicon-search"></i></button>
            </span>
          </div>

        <p><small>
            FILTER BY: <a href="#" data-toggle="tooltip" data-placement="right" title="" data-original-title="You may browse for projects with specific attributes including project topic, project status, intended age group, and many others."><span class="glyphicon glyphicon-info-sign"></span></a>
        </small></p>

          <div id="project_topic_filter" class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                  Project Topic
                </a>
              </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
              <div id="project_topic" class="panel-body">
              </div>
            </div>
          </div>
          <div id="agency_sponsor_filter" class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingThree">
              <h4 class="panel-title">
                <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                  Agency Sponsor
                </a>
              </h4>
            </div>
            <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
              <div id="agency_sponsor" class="panel-body">
              </div>
            </div>
          </div>
          <div id="agency_partner_filter" class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingFour">
              <h4 class="panel-title">
                <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                  Agency Partner
                </a>
              </h4>
            </div>
            <div id="collapseFour" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFour">
              <div id="agency_partner" class="panel-body">
              </div>
            </div>
          </div>
          <div id="participant_age_filter" class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingSix">
              <h4 class="panel-title">
                <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseSix" aria-expanded="false" aria-controls="collapseSix">
                  Participant Age
                </a>
              </h4>
            </div>
            <div id="collapseSix" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingSix">
              <div id="participant_age" class="panel-body">
              </div>
            </div>
          </div>
          <div id="intended_outcomes_filter" class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingSeven">
              <h4 class="panel-title">
                <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseSeven" aria-expanded="false" aria-controls="collapseSeven">
                  Intended Outcomes
                </a>
              </h4>
            </div>
            <div id="collapseSeven" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingSeven">
              <div id="intended_outcomes" class="panel-body">
              </div>
            </div>
          </div>
        </section>


        <section id="projects" class="col-md-2">
          <div class="row">
            <div id="projects-summary" class="col-md-6 text-center">
              <h5>PROJECTS</h5>
              <h2><span class="project-num">0</span></h2>
            </div>
            <div id="agencies-summary" class="col-md-6 text-center">
              <h5>AGENCIES</h5>
              <h2><span class="agency-num">0</span></h2>
            </div>
          </div>
          <ul id="project_list" class="list-unstyled">
          </ul>
        </section>

      <section id="map-container" class="col-md-8">
        <div id="map" class="row"></div>
      </section>

    </main>

    <footer>
      <div class="row footer-nav">
        <div class="col-md-offset-2 col-md-2">
          <ul class="list-unstyled">
            <li><a href="index.html">Home</a></li>
            <li><a href="add.html">Add project</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="data-policy.html">Data policy</a></li>
            <li><a href="http://www.wilsoncenter.org/privacy-policy">Privacy policy</a></li>
          </ul>
        </div>
        <div class="initiative-by col-md-offset-2 col-md-6">
          <p >An initiative led by:</p>
          <image xlink:href="img/commons_logo.svg" src="img/commons_logo.png"
                 width="260" height="40" />
          <image xlink:href="img/wilson_logo.svg" src="img/wilson_logo.png"
                 width="260" height="40" />

        </div>
      </div>

      <div class="row copyright">
        <div class="col-md-12 text-center"><p>Copyrighted by <a href="http://wilsoncenter.org/the-commons-lab-inventory">Wilson Center</a> &#169; 2015 Â· Developed by <a href="http://icarto.es" target="_blank">iCarto</a></p></div>
      </div>

    </footer>

    <!-- templates -->
    <script type="text/template" id="filter-checkbox-tmpl">
      <div class="checkbox">
        <label>
          <input type="checkbox" name="<%- property_code %>" onchange="Javascript:applyQuery();return false;"/>
          <%- property_name %>
        </label>
      </div>
    </script>

    <!-- templates -->
    <script type="text/template" id="filter-checkbox-other-tmpl">
      <div class="checkbox">
        <label>
          <input type="checkbox" name="other" onchange="Javascript:applyQuery();return false;"/>
          Other
        </label>
      </div>
    </script>

    <script type="text/template" id="project-list-tmpl">
      <li><a href="#projectId/<%- cartodb_id %>"><%- project_name %></a><br/>
        <small style="color: grey; font-size: 75%"> by <%
            var sponsors = [];
            if (agency_sponsor) {
                agency_sponsor.split(",").forEach(function (item) {
                    var property = properties.findWhere({property_code: item.replace(/\s/g, '')});
                    if (typeof(property) != "undefined") {
                        sponsors.push(property.get('property_name'));
                    }else if (item.replace(/\s/g, '') == 'other') {
                        sponsors.push('Other');
                    }
                });
            }else{
              sponsors.push('n/a');
            }
            %>
        <%= sponsors.join(', ') %>        
        </small></li>
    </script>

    <script type="text/template" id="project-data-tmpl">
      <button type="button" id="close" class="close col-md-1 " onclick="Javascript:close_project_panel();return false;">&times;</button>
      <h3 class="col-md-12"><%- project_name %></h3>
      <% if (project_url != null && project_url != '' && project_url != 'n/a' && project_url != '0') { %>
      <p class="col-md-12"><a href="<%- project_url %>" target="_blank"><%- project_url %></a></p>
      <% } %>

      <p class="col-md-12"><%- project_description %></p>
      <p class="col-md-12"><strong>Keywords:</strong> <%- keywords %></p>
      <p class="col-md-12"><strong>Fields of science:</strong><%
        var topics = [];
        project_topic.split(",").forEach(function (item) {
            var property = properties.findWhere({property_code: item.replace(/\s/g, '')});
            if (typeof(property) != "undefined") {
                topics.push(property.get('property_name'));
            }else if (item.replace(/\s/g, '') == 'other') {
                topics.push('Other');
            }
        });
        %>
        <%= topics.join(', ')  %>
      </p>
      <p class="col-md-12"><span><strong>Status:</strong><%
        var property = properties.findWhere({property_code: status});
        %>
        <%= property.get('property_name') %>
      </span></p>
      <p class="col-md-12"><span><strong>Start date:</strong> <%- start_date %></span></p>
      <p class="col-md-12"><strong>Federal Government Sponsor:</strong><%
        var sponsors = [];
        agency_sponsor.split(",").forEach(function (item) {
            var property = properties.findWhere({property_code: item.replace(/\s/g, '')});
            if (typeof(property) != "undefined") {
                sponsors.push(property.get('property_name'));
            }else if (item.replace(/\s/g, '') == 'other') {
                sponsors.push('Other');
            }
        });
        %>
        <%= sponsors.join(', ')
        %></p>
      <p class="col-md-12"><strong>Other Federal Government Sponsor:</strong> <%- agency_sponsor_other %></p>
      <p class="col-md-12"><strong>Type of Nonfederal Government Sponsor:</strong><%
        var partners = [];
        agency_partner.split(",").forEach(function (item) {
            var property = properties.findWhere({property_code: item.replace(/\s/g, '')});
            if (typeof(property) != "undefined") {            
                partners.push(property.get('property_name'));
            }else if (item.replace(/\s/g, '') == 'other') {
                partners.push('Other');
            }
        });
        %>
        <%= partners.join(', ') %>
      </p>
      <p class="col-md-12"><strong>Name of
Nonfederal Government Sponsors:</strong> <%- agency_partner_name %></p>
      <p class="col-md-12"><strong>Geographic scope:</strong> <%- geographic_scope %></p>
      <p class="col-md-12"><strong>Intended outcomes:</strong><%
        var outcomes = [];
        intended_outcomes.split(",").forEach(function (item) {
            var property = properties.findWhere({property_code: item.replace(/\s/g, '')});
            if (typeof(property) != "undefined") {
                outcomes.push(property.get('property_name'));
            }else if (item.replace(/\s/g, '') == 'other') {
                outcomes.push('Other');
            }
        });
        %>
        <%= outcomes.join(', ') %>
      </p>
      <p class="col-md-12"><strong>Participation tasks:</strong><% 
        var tasks = [];
        participation_tasks.split(",").forEach(function (item) {
            var property = properties.findWhere({property_code: item.replace(/\s/g, '')});
            if (typeof(property) != "undefined") {
                tasks.push(property.get('property_name'));
            }else if (item.replace(/\s/g, '') == 'other') {
                tasks.push('Other');
            }
        });
        %>
        <%= tasks.join(', ') %>
      </p>
      <p class="col-md-12"><strong>Participant age:</strong><%
        var ages = [];
        participant_age.split(",").forEach(function (item) {
            var property = properties.findWhere({property_code: item.replace(/\s/g, '')});
            if (typeof(property) != "undefined") {
                ages.push(property.get('property_name'));
            }else if (item.replace(/\s/g, '') == 'other') {
                ages.push('Other');
            }
        });
        %>
        <%= ages.join(', ') %>
      </p>
      <% if (recruiting) { %>
        <p class="col-md-12"><strong>Recruiting Volunteers:</strong> Yes, this project is recruiting</p>
    <% } %>
      <div class="col-md-12" id="contact_info">
        <h4>Contact information</h4>
        <div><span class="glyphicon glyphicon-user" aria-hidden="true"></span><span><%- project_contact %></span><span><%- affiliation? ' - ' + affiliation : '' %></span></div>
        <div id="contact_address"><span class="glyphicon glyphicon-home" aria-hidden="true"></span><% if ((street_address != null && street_address != '' && street_address != 'n/a') ||
          (street_address_2 != null && street_address_2 != '' && street_address_2 != 'n/a')) { %>
        <span><%- street_address %> <%- street_address_2 %></span>
        <% } %>
        <span><%- city ? ' - ' + city + ', ' : ' - ' %><%- state %> <%- zip ? '(' + zip + ')' : '' %></span></div>
        <% if (phone != null && phone != '' && phone != 'n/a' && phone != '0') { %>
        <span><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span><%- phone %></span><br>
        <% } %>
        <% if (email != null && email != '' && email.indexOf('@') != -1) { %>
        <span><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span><a href="mailto:<%- email %>" target="_top"><%- email %></a></span>
        <% } %>

      </div>


    </script>

    <script type="infowindow/html" id="infowindow_template">
      <div class="cartodb-popup v2">
        <a href="#close" class="cartodb-popup-close-button close">x</a>
        <div class="cartodb-popup-content-wrapper">
          <div class="cartodb-popup-content">
            <h3><%- project_name %></h3>
            <p><a href="<%- project_url %>" target="_blank"><%- project_url %></a></p>
            <p><strong style="color:#FE8433">Keywords</strong>: <%- keywords %></p>
            <p><a href="#projectId/<%- cartodb_id %>">Expand project</a></p>
          </div>
        </div>
        <div class="cartodb-popup-tip-container"></div>
      </div>
    </script>

    <script src="js/vendor/jquery-min-1.11.3.js"></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/vendor/cartodb.js"></script>
    <script src="js/vendor/json2.js"></script>
    <script src="js/vendor/underscore-min-1.8.2.js"></script>
    <script src="js/vendor/backbone-min-1.2.1.js"></script>
    <!-- our own -->
    <script src="js/config.js"></script>
    <script src="js/CCSI.js"></script>
    <script src="js/models/Property.js"></script>
    <script src="js/models/Project.js"></script>
    <script src="js/collections/Properties.js"></script>
    <script src="js/collections/Projects.js"></script>
    <script src="js/views/PropertyComponent.js"></script>
    <script src="js/views/OtherFilterComponent.js"></script>
    <script src="js/views/ProjectPanel.js"></script>
    <script src="js/views/ProjectList.js"></script>
    <script src="js/routers/Project.js"></script>
    <script src="js/main.js"></script>

    <script>
      // Flag we use for identifying when both the map and project collection
      // have been loaded
      var ready = false;
      var map;
      var previous_zoom = 3;
      var previous_center = [36, -97];
      var layer;
      var jsonViz = cdb_inventory_viz;
      function main() {
        cartodb.createVis('map', jsonViz, {
          tiles_loader: true,
          center_lat: 36,
          center_lon: -97,
          zoom: 3,
          infowindow: false
        }).done(function(vis, layers) {
          // you can get the native map to work with it
          map = vis.getNativeMap();
          layer = layers[1];

          // Hack needed in order to add the infowindow programmatically
          map.viz = vis;
          // Manually add our infowindow

           var sublayer = layer.getSubLayer(0);

           sublayer.setInteraction(true);

           sublayer.infowindow.set('sanitizeTemplate',false);

           sublayer.infowindow.set('template', $('#infowindow_template').html());

          /*
          cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(0),
            ['cartodb_id', 'project_name', 'keywords', 'agency_sponsor', 'project_url'],
            {
              infowindowTemplate: $('#infowindow_template').html(),
              templateType: 'underscore',
              triggerEvent: 'featureClick',
              cursorInteraction: true,
              sanitizeTemplate: false
            }
          );
          */
          if (ready) {
            Backbone.history.start();
          }
          ready = true;
        }).error(function(err) {
          console.log(err);
        });

        $("#searchinput").keyup(function(){
          $("#searchclear").toggle(Boolean($(this).val()));
        });

        $("#searchclear").toggle(Boolean($("#searchinput").val()));

        $("#searchclear").click(function(){
          $("#searchinput").val('').focus();
          $(this).hide();
          applyQuery();
        });

        $("#filter-btn").click(function() {
          applyQuery();
        });

        $('#searchinput').bind("keypress", function (e) {
          if (e.keyCode == 13) {
            applyQuery();
          }
        });

        $("#searchclear").click(function(){
          $("#searchinput").val('').focus();
          $(this).hide();
          applyQuery();
        });

        $('#searchinput').bind('notext', function () {
          applyQuery();
        });

        // Detect Browser Back Button 
        $( document ).ready(function($) {

          if (window.history && window.history.pushState) {

            $(window).on('popstate', function() {
              var hashLocation = location.hash;
              var hashSplit = hashLocation.split("#!/");
              var hashName = hashSplit[1];

              if (hashName !== '') {
                var hash = window.location.hash;
                if (hash === '') {
                  // project view visible?
                  if ($('#project-list-tmpl').length > 0) {
                    close_project_panel();
                  }
                }
              }
            });
          }

        });
      }

      window.onload = main;

    </script>

  </body>
</html>
